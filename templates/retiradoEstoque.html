{% extends "base_template.html" %}

{% block stylepath %}
{{ url_for('static', filename='retiradoEstoque/retiradoEstoque.css') }}
{% endblock %}

{% block content %}
<br>
<div class="container">
  <!-- Header -->
  <div>
    <div class="header-bar bg-primary text-white p-3 rounded mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Retirada do estoque</h5>
        <button id="btnToggleRetirada" class="btn btn-link text-white p-0 d-block d-md-none" type="button"
          data-bs-toggle="collapse" data-bs-target="#detalhesRetirada" aria-expanded="false"
          aria-controls="detalhesRetirada">
          <i class="bi bi-chevron-down fs-4"></i>
        </button>
      </div>
      <div id="detalhesRetirada" class="collapse d-md-block mt-3">
        <div class="d-flex flex-wrap align-items-center gap-3">
          <div>
            <strong style="color: #FDD484;">Empresa:</strong>
            {% if dados_agend.empresa == 0 %}Nenhuma
            {% elif dados_agend.empresa == 1 %}Ja√∫ Pesca
            {% elif dados_agend.empresa == 2 %}Ja√∫ Fishing
            {% elif dados_agend.empresa == 3 %}L.T. Sports
            {% endif %}
          </div>
          <div><strong style="color: #FDD484;">Agendamento:</strong> {{ dados_agend.id_agend_ml }}</div>
          <div><strong style="color: #FDD484;">Colaborador:</strong> {{ dados_agend.colaborador or 'Nenhum' }}</div>
          {% set data = dados_agend.entrada %}
          <div><strong style="color: #FDD484;">Data:</strong> {{ data.strftime('%d/%m/%y') }}</div>
          <div><strong style="color: #FDD484;">Hora:</strong> {{ data.strftime('%Hh%M') }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main row -->
  <div class="row">
    <!-- Coluna de inputs e indicadores -->
    <div class="col-md-5">
      <div class="mb-3">
        <div class="row">
          <div class="col">
            <label class="form-label fw-bold">C√≥digo ou SKU</label>
            <input type="text" id="skuInput" class="form-control" placeholder="Digite aqui" {% if not pode_mudar %}disabled{% endif %}>
          </div>
          <div class="col">
            <label class="form-label fw-bold">Insira a quantidade</label>
            <input type="number" id="quantidadeInput" class="form-control" value="1" min="1" {% if not pode_mudar %}disabled{% endif %}>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between flex-wrap gap-3 p-3 mb-3 border rounded bg-white">
        <p id="tempoP" class="mb-0"><strong>üïí Tempo:</strong> 00h 00m 00s</p>
        <p id="andamentoP" class="mb-0"><strong>üîÑ Em andamento:</strong> Nenhum</p>
        <p id="estimadoP" class="mb-0"><strong>‚è≥ Estimado:</strong> 00h 45m 00s</p>
        <p id="finalizadosP" class="mb-0"><strong>‚úÖ Finalizados:</strong> Nenhum</p>
        <div id="finalizarContainer" class="d-none mt-2 w-100">
          <button id="btnFinalizar" class="btn btn-outline-success btn-lg w-100" onclick="finalizarAgendamento()">
            <i class="bi bi-check-circle me-2"></i>Finalizar Agendamento
          </button>
        </div>
      </div>

      <!-- Bloco para itens conclu√≠dos -->
      <div id="concluidosContainer" class="info-box mb-3 overflow-auto" style="max-height: 30vh;">
        <!-- JS injeta aqui os itens com bipados >= total -->
      </div>
    </div>

    <!-- Lista de produtos pendentes -->
    <div class="col-md-7">
      <div id="pendentesContainer" class="overflow-auto" style="max-height: 70vh;">
        {% for composicao in dados %}
        <div class="produto-item d-flex flex-column mb-3 me-2"
             data-sku="{{ composicao.sku }}"
             data-gtin=""
             data-total="{{ composicao.unidades_totais }}"
             data-bipados="0">
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-truncate d-inline-block w-100" style="max-width: 400px;" title="{{ composicao.nome }}">
              {{ composicao.comp_origem[0].nome }}
            </span>


            <div class="sku-actions">
              <button class="btn-icon btn-pencil" type="button" aria-label="Editar produto"
                      onclick="editarProdutoCompLapis('{{ composicao.sku }}')">
                <!-- √≠cone l√°pis (SVG) -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M12 20h9"/>
                  <path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
                </svg>
              </button>

              <button id="btnEquivalente-{{ composicao.sku }}"
                      class="btn-icon btn-add" type="button" aria-label="Adicionar equivalente"
                      onclick="adicionarEquivalente('{{ composicao.sku }}')">

                <!-- √≠cone plus (SVG) -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
              </button>
            </div>

            <div class="d-flex align-items-center gap-3">
              <span class="text-success">{{ composicao.sku }}</span>
              <span class="bipados text-nowrap">Bipados: 0</span>
            </div>
          </div>

          <div class="progress mt-2" style="height: 12px;">
            <div class="progress-bar bg-warning text-secondary"
                 role="progressbar"
                 style="width: 0%;"
                 aria-valuenow="0"
                 aria-valuemin="0"
                 aria-valuemax="{{ composicao.unidades_totais }}">
              0%
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Modal de edi√ß√£o de produto (custom, usa CSS pr√≥prio) -->
  <div id="modal-editar-produto" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="tituloModalEditarProduto">
      <h2 id="tituloModalEditarProduto" class="titulo-vermelho">Editar Produto</h2>

      <!-- Layout do modal: esquerda (master) | direita (lista) -->
      <div id="modalEditorWrap" class="modal-grid">
        <!-- Painel esquerdo -->
        <aside id="conteudoModalEditarProduto" class="info-box">
          <p>Produto: <strong id="master-nome">‚Äî</strong></p>
          <p>SKU: <strong id="master-sku-view">‚Äî</strong></p>
          <p>GTIN/EAN: <strong id="master-gtin">‚Äî</strong></p>
          <img id="master-img" style="max-width:100%;height:auto" src="{{ url_for('static', filename='resources/sem_img.webp') }}" alt="Imagem do produto">
        </aside>

        <!-- Lista (original + equivalentes) -->
        <section id="listaProdutos" class="produtos-scroll">
          <div class="header-bar">Produtos neste conjunto</div>
          {# JS popula aqui os cards .produto-item-modal com lixeira e controles #}
        </section>
      </div>

      <!-- Rodap√© -->
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" onclick="fecharModal()">Cancelar</button>
        <button id="btn-salvar-edicoes" type="button" class="btn btn-primary" onclick="salvarAlteracoes()">
          Salvar Altera√ß√µes
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: adicionar equivalente -->
  <div id="modal-equivalente" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="tituloModalEquivalente">
      <h2 id="tituloModalEquivalente" class="titulo-vermelho">Adicionar equivalente</h2>

      <div class="info-box" style="margin-bottom:12px;">
        <p>SKU original: <strong id="eq-sku-master">‚Äî</strong></p>
        <p class="text-muted" style="margin:-6px 0 8px 0;font-size:.9rem">
          Bipe o SKU/GTIN do produto que ser√° usado como equivalente.
        </p>
        <input id="eq-input" type="text" class="form-control" placeholder="Bipe aqui o SKU/GTIN">
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-outline" onclick="fecharModalEquivalente()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="confirmarModalEquivalente()">Adicionar</button>
      </div>
    </div>
  </div>

  <!-- Overlay de erro da busca de equivalente (usado pelo JS) -->
  <div id="erroBuscaEquivalenteDiv" class="input-equivalente-off"
       style="position: fixed; border: 1px solid red; width: 100px; height: 100px;"></div>
</div>

<!-- Dados para o JS -->
<div id="js-data" data-comps='{{ comps | tojson | safe }}' data-dados="{{ dados }}" style="display:none;"></div>
<div id="infoAgend"
     data-empresa='{{ dados_agend.empresa }}'
     data-agendamento='{{ dados_agend.id_agend_ml }}'
     data-colaborador='{{ dados_agend.colaborador or "Nenhum" }}'
     data-marketplace='{{ marketplace_nome }}'
     style="display:none;"></div>
{% endblock %}

{% block scriptpath %}
{{ url_for('static', filename='retiradoEstoque/retiradoEstoque.js') }}
{% endblock %}