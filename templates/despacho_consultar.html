{% extends "base_template.html" %}

{% block title %}Despacho • Consultar pedidos{% endblock %}

{% block stylepath %}
{{ url_for('static', filename='despacho_consultar/despacho_consultar.css') }}
{% endblock %}

{% block content %}
<div class="container pt-4">
    <div class="panel-control">

        <div class="panel-title d-flex align-items-center justify-content-between gap-2 flex-wrap">
        <h5 class="mb-0">Despacho • Consultar pedidos</h5>

        <a class="btn btn-outline-secondary" href="{{ url_for('despacho.despacho_crossdocking') }}">
            ← Voltar
        </a>
        </div>

        <div class="panel-content">

        <!-- BUSCA (limpa, sem poluir a tela) -->
        <div class="card shadow-sm dc-search-card">
            <div class="card-body">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                <div class="dc-search-title">Pesquisar</div>

                <!-- Abre modal (Bootstrap fecha ao clicar fora por padrão) -->
                <button
                type="button"
                class="btn btn-outline-secondary dc-icon-btn"
                data-bs-toggle="modal"
                data-bs-target="#modalFiltrosAvancados"
                aria-controls="modalFiltrosAvancados"
                >
                <!-- ícone funil -->
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.8.4l-1.7-1.275L6.3 14.9a.5.5 0 0 1-.3-.4v-4z"/>
                    <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .4.8L10 7v1a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7L1.6 1.8a.5.5 0 0 1-.1-.3z"/>
                </svg>
                Filtros avançados
                </button>
            </div>

            <div class="dc-search-row">
                <div>
                <label class="form-label fw-bold">Marketplace</label><br>
                <small class="text-muted">Selecione o Marketplace.</small>
                <select id="qMarketplace" class="form-select">
                    <option value="">Todos</option>
                </select>
                </div>

                <div>
                <label class="form-label fw-bold">Chave NF-e (44 dígitos) ou Nº da nota</label><br>
                <small class="text-muted">Dica: ao colar/digitar 44 dígitos, a busca dispara automaticamente.</small>
                <input
                    id="qInput"
                    type="text"
                    class="form-control"
                    inputmode="numeric"
                    autocomplete="off"
                    placeholder="Cole/digite aqui..."
                />
                </div>

                <div>
                <button id="qBtnBuscar" class="btn btn-primary-custom w-100" type="button">
                    Buscar
                </button>
                </div>
            </div>

            <div id="dcErr" class="alert alert-danger d-none mt-3 mb-0"></div>
            </div>
        </div>

        <!-- RESULTADOS -->
        <div class="card shadow-sm mt-3">
            <div class="card-body">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
                <div class="fw-bold">Resultados</div>
                <div id="resultsCount" class="badge">0</div>
            </div>

            <div id="dcLoading" class="text-muted d-none mb-2">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Buscando...
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                <thead>
                    <tr>
                    <th>ID</th>
                    <th>Marketplace</th>
                    <th>ID MKTP</th>
                    <th>Chave acesso NF-e</th>
                    <th>Nº Nota</th>
                    <th>Data</th>
                    <th>Hora</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    <tr>
                    <td colspan="7" class="text-muted">Nenhuma busca realizada.</td>
                    </tr>
                </tbody>
                </table>
            </div>

            </div>
        </div>

        </div>
    </div>
    </div>

    <!-- MODAL: Filtros avançados (estilo Tiny: clicou fora, fecha) -->
    <div class="modal fade" id="modalFiltrosAvancados" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

        <div class="modal-header">
            <h5 class="modal-title">Filtros avançados</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body">
            <div class="row g-3">
            <div class="col-12 col-md-4">
                <label class="form-label fw-bold">Marketplace</label>
                <select id="fltMarketplace" class="form-select">
                <option value="">Todos</option>
                </select>
            </div>

            <div class="col-12 col-md-8">
                <label class="form-label fw-bold">Chave de acesso (44 dígitos)</label>
                <input id="fltChave" type="text" class="form-control" inputmode="numeric" placeholder="Somente números ou com máscara" />
            </div>

            <div class="col-12 col-md-4">
                <label class="form-label fw-bold">Número da nota</label>
                <input id="fltNumeroNota" type="text" class="form-control" placeholder="Ex: 123456" />
            </div>

            <div class="col-12 col-md-4">
                <label class="form-label fw-bold">Data (de)</label>
                <input id="fltDataDe" type="date" class="form-control" />
            </div>

            <div class="col-12 col-md-4">
                <label class="form-label fw-bold">Data (até)</label>
                <input id="fltDataAte" type="date" class="form-control" />
            </div>

            <div class="col-6 col-md-4">
                <label class="form-label fw-bold">Hora (de)</label>
                <input id="fltHoraDe" type="time" class="form-control" step="1" />
            </div>

            <div class="col-6 col-md-4">
                <label class="form-label fw-bold">Hora (até)</label>
                <input id="fltHoraAte" type="time" class="form-control" step="1" />
            </div>
            </div>
        </div>

        <div class="modal-footer d-flex flex-wrap gap-2">
            <button id="btnLimpar" class="btn btn-outline-secondary" type="button">
            Limpar
            </button>

            <!-- fecha o modal ao aplicar (sem mexer no JS de busca) -->
            <button id="btnBuscar" class="btn btn-primary-custom" type="button" data-bs-dismiss="modal">
            Buscar
            </button>
        </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scriptpath %}
{{ url_for('static', filename='despacho_consultar/despacho_consultar.js') }}
{% endblock %}
